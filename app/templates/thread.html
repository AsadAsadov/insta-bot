{% extends "base.html" %}

{% block title %}Thread {{ active_thread }}{% endblock %}

{% block content %}
<div class="row g-4">
  <div class="col-12 col-lg-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h5 class="mb-0">Threads</h5>
          <a class="btn btn-sm btn-outline-primary" href="/admin">All</a>
        </div>
        <input
          id="threadSearch"
          class="form-control mb-3"
          placeholder="Search threads..."
          type="text"
        />
        <div class="list-group" id="threadList">
          {% for thread in threads %}
          <a
            href="/admin/thread/{{ thread.id }}"
            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start thread-item {% if thread.id == active_thread %}active{% endif %}"
            data-thread-id="{{ thread.id }}"
          >
            <div class="me-auto">
              <div class="fw-semibold">{{ thread.id }}</div>
              <small class="text-muted">{{ thread.last_message or "No messages yet" }}</small>
            </div>
            <span class="badge badge-soft">{{ thread.last_ts }}</span>
          </a>
          {% else %}
          <div class="text-muted">No threads yet.</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-8">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h5 class="mb-0">Thread {{ active_thread }}</h5>
            <small class="text-muted">{{ events | length }} events</small>
          </div>
          <span class="badge text-bg-secondary">IGSID</span>
        </div>
        {% if latest_failed %}
        <div class="alert alert-danger" role="alert">
          Last API error: {{ latest_failed.error }}
        </div>
        {% endif %}
        <div class="d-flex flex-column gap-3">
          {% for event in events %}
          <div class="d-flex {% if event.event_type == 'message_out' %}justify-content-end{% else %}justify-content-start{% endif %}">
            <div class="chat-bubble {% if event.event_type == 'message_out' %}chat-out{% else %}chat-in{% endif %}">
              <div>{{ event.text or "(no text)" }}</div>
              <div class="chat-meta mt-1">
                {{ event.received_at }} Â· {{ event.event_type }}
              </div>
            </div>
          </div>
          {% else %}
          <div class="text-muted">No messages yet.</div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <form method="post" action="/admin/message-reply">
          <input type="hidden" name="thread_id" value="{{ active_thread }}" />
          <div class="mb-3">
            <label class="form-label fw-semibold">Quick reply</label>
            <select class="form-select" id="quickReply">
              <option value="">Select a template...</option>
              {% for template in templates %}
              <option value="{{ template.reply_text }}">{{ template.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Your reply</label>
            <textarea class="form-control" name="text" id="replyText" rows="4" required></textarea>
          </div>
          <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-primary">Send reply</button>
          </div>
        </form>
      </div>
    </div>

    <div class="card shadow-sm mt-3">
      <div class="card-body">
        <h6 class="fw-semibold mb-3">Recent send attempts</h6>
        {% for entry in outbox_entries %}
        <div class="d-flex justify-content-between align-items-start border-bottom pb-2 mb-2">
          <div>
            <div class="fw-semibold">{{ entry.text }}</div>
            <small class="text-muted">{{ entry.created_at }}</small>
          </div>
          <span class="badge text-bg-{% if entry.status == 'sent' %}success{% elif entry.status == 'failed' %}danger{% else %}secondary{% endif %}">
            {{ entry.status }}
          </span>
        </div>
        {% else %}
        <div class="text-muted">No send attempts yet.</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const quickReply = document.getElementById("quickReply");
  const replyText = document.getElementById("replyText");
  if (quickReply && replyText) {
    quickReply.addEventListener("change", (event) => {
      if (event.target.value) {
        replyText.value = event.target.value;
      }
    });
  }
  const searchInput = document.getElementById("threadSearch");
  const list = document.getElementById("threadList");
  if (searchInput && list) {
    searchInput.addEventListener("input", (event) => {
      const query = event.target.value.toLowerCase();
      list.querySelectorAll(".thread-item").forEach((item) => {
        const text = item.dataset.threadId.toLowerCase();
        item.style.display = text.includes(query) ? "flex" : "none";
      });
    });
  }
</script>
{% endblock %}
